<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Select Students</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-slate-800">

    <%- include("../partials/adminHeader.ejs") %>

        <div class="flex h-screen overflow-hidden pt-16 md:pt-0">
            <%- include("../partials/adminSidebar.ejs") %>

                <main class="flex-1 overflow-y-auto p-6 md:p-10">

                    <div class="max-w-7xl mx-auto">

                        <!-- Header -->
                        <div class="mb-6 flex justify-between">
                            <div>
                                <h1 class="text-3xl font-bold">
                                    <%= cls.className %> — Students
                                </h1>
                                <p class="text-gray-500 text-sm mt-2">
                                    <%= school.name %> · Select students to print ID cards
                                </p>
                            </div>
                            <div>
                                <select id="sectionFilter"
                                    class="px-4 py-2 rounded-xl border border-gray-300 bg-white text-sm">
                                    <option value="all" <%=selectedSection==="all" ? "selected" : "" %>>
                                        All Sections
                                    </option>

                                    <% ["A","B","C","D"].forEach(sec=> { %>
                                        <option value="<%= sec %>" <%=selectedSection===sec ? "selected" : "" %>>
                                            Section <%= sec %>
                                        </option>
                                        <% }) %>
                                </select>
                            </div>
                        </div>

                        <% if(students.length==0){%>
                            <div class="bg-gray-100 text-gray-700 py-3 text-center">No students here to print ID cards
                            </div>
                            <%} else{%>
                                <!-- Actions -->
                                <div class="flex flex-wrap gap-3 mb-6">
                                    <button onclick="clearSelection()"
                                        class="px-4 py-2 rounded-lg bg-gray-200 text-sm font-semibold">
                                        Clear
                                    </button>

                                    <button onclick="goToPreview()"
                                        class="ml-auto px-6 py-2 rounded-xl bg-green-600 text-white font-bold">
                                        Prepare Print (<span id="count">
                                            <%= cart.length %>
                                        </span>)
                                    </button>
                                </div>
                                <!-- Students -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <% students.forEach(stu=> { %>
                                        <div data-id="<%= stu._id %>" onclick="toggleStudent('<%= stu._id %>', this)"
                                            class="student-card cursor-pointer bg-white rounded-xl border p-4 flex items-center gap-4 
                                            <%= cart.includes(stu._id.toString()) ? 'ring-2 ring-indigo-500' : '' %> 
                                            <%= stu.status === 'PRINTED' ? 'opacity-40 pointer-events-none' : '' %>">
                                            <input type="checkbox" class="hidden" />
                                            <div class="h-12 w-12 rounded-full bg-gray-100 overflow-hidden">
                                                <% if (stu.image) { %>
                                                    <img src="<%= stu.image %>" class="w-full h-full object-cover">
                                                    <% } %>
                                            </div>
                                            <div class="flex-1">
                                                <p class="font-semibold">
                                                    <%= stu.name %>
                                                </p>
                                                <p class="text-xs text-gray-500">
                                                    Father: <%= stu.fatherName || "-" %> • Sec:
                                                        <%= stu.sectionId ? stu.sectionId.sectionName : "-" %>
                                                </p>
                                            </div>
                                            <% if (stu.status==="PRINTED" ) { %>
                                                <span
                                                    class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">
                                                    PRINTED
                                                </span>
                                                <% } %>
                                        </div>
                                        <% }) %>
                                </div>
                                <button onclick="selectFirst10()"
                                    class="fixed bottom-6 right-6 px-5 py-3 rounded-xl bg-indigo-600 text-white font-bold shadow-lg">
                                    Select 10 IDs
                                </button>

                                <%} %>
                    </div>
                </main>
        </div>

        <script>
            async function toggleStudent(id, el) {
                const res = await fetch("/superAdmin/print/cart/toggle", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ studentId: id })
                });

                const data = await res.json();
                if (!data.success) return;

                el.classList.toggle("ring-2");
                el.classList.toggle("ring-indigo-500");
                document.getElementById("count").innerText = data.count;
            }

            async function clearSelection() {
                await fetch("/superAdmin/print/cart/clear", {
                    method: "POST"
                });

                document.querySelectorAll(".student-card").forEach(el => {
                    el.classList.remove("ring-2", "ring-indigo-500");
                });

                document.getElementById("count").innerText = 0;
            }

            function goToPreview() {
                window.location.href = "/superAdmin/print/preview";
            }
        </script>


</body>

</html>